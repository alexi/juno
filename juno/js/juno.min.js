!function o(i,l,s){function r(t,e){if(!l[t]){if(!i[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(a)return a(t,!0);throw(e=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",e}n=l[t]={exports:{}},i[t][0].call(n.exports,function(e){return r(i[t][1][e]||e)},n,n.exports,o,i,l,s)}return l[t].exports}for(var a="function"==typeof require&&require,e=0;e<s.length;e++)r(s[e]);return r}({1:[function(e,t,n){const r=e("./utils.js");class i{constructor(e){this.starting_cell=e,this.cells=[this.starting_cell],this.session_id=r.generateId(),this.cell_states={}}get_cell_state(e){return this.cell_states[e.cell_id]}set_cell_state(e,t){this.cell_states[e.cell_id]=t}}t.exports=class{constructor(){this.agent=null}start(t,e,n){this.agent=new i(t);let o=document.createElement("div");o.id="juno-agent-spinner",o.style="display: flex; align-items: center; margin-left:114px; margin-top: 10px; margin-bottom: 10px; padding: 10px; border: 1px solid #e6e6e6; border-radius: 3px; background-color: #f9f9f9; font-size: 12px; color: #666;",o.innerHTML="<div class='juno-spinner'></div><span style='padding-left:1px;'>planning...</span>",setTimeout(()=>{var e=t.output_area;console.log("starting cell output area:",e),e.element.append(o)},400),r.call("agent_start",{agent_id:this.agent.session_id,data_info:n,command:e,prev_transcript:r.getContext(5)},e=>{o.remove(),this.handle_agent_start_response(e)})}done(){this.agent=null}handle_agent_start_response(e){console.log("handle_agent_start_response response:",e);let t=this.agent.cells[this.agent.cells.length-1];e=t.get_text(),e=r.replaceLastOccurrence(e,"%agent","# %agent");t.set_text(e),setTimeout(()=>{var e=Jupyter.notebook.find_cell_index(t);Jupyter.notebook.select(e+1),Jupyter.notebook.get_cell(e+1).focus_editor()},200),this.get_next()}handle_output_appended(){}handle_cell_executed(t){if(console.log("handle_cell_executed id:",t.cell_id,"index:",Jupyter.notebook.find_cell_index(t)),this.agent&&1!=this.agent.cells.length){var n=this.agent.cells[this.agent.cells.length-1];if(console.log("last-cell-id:",n.cell_id),t.cell_id==n.cell_id){n=this.agent.get_cell_state(t);if(n){if("querying"==n)this.agent.set_cell_state(t,"executed");else if("executed"==n)return void console.log("already handled handle_cell_executed id:",t.cell_id);console.log("continuing handle_cell_executed id:",t.cell_id,"index:",Jupyter.notebook.find_cell_index(t));let e=Jupyter.notebook.find_cell_index(t);r.cellHasErrorOutput(t)&&console.log("cell has error output"),setTimeout(()=>{Jupyter.notebook.select(e+1),Jupyter.notebook.get_cell(e+1).focus_editor()},20),setTimeout(()=>{this.get_next()},20)}else console.log("initially query handle_cell_executed id:",t.cell_id),this.agent.set_cell_state(t,"querying")}}}get_next(){var e={agent_id:this.agent.session_id};call("agent_next",e,e=>{this.handle_agent_next_response(e)})}handle_agent_next_response(t){if(console.log("handle_agent_next_response response:",t),"next"===t.action){var n=Jupyter.notebook.find_cell_index(this.agent.cells[this.agent.cells.length-1]);let e=Jupyter.notebook.get_cell(n+1);(e=null===e?Jupyter.notebook.insert_cell_below("code"):e).set_text(t.message),this.agent.cells.push(e),console.log("executing cell:",e.cell_id,"index:",Jupyter.notebook.find_cell_index(e),"i+1:",n+1),e.execute()}else"done"===t.action&&this.done()}async stream_action(e,o,i,l){if(this.agent){let t=this.agent.cells[this.agent.cells.length-1];var s=Jupyter.notebook.find_cell_index(t),e={command:e,data_info:o,agent_id:this.agent.session_id},o=(i&&(e.prev_transcript=r.getContext(l,0)),t.get_text());let n=r.replaceLastOccurrence(o,"%action","# %action")+"\n";Jupyter.notebook.select(s);await r.stream("query",e,e=>{void 0!==e&&(e=(n+=e).replace(/`+$/,"").replace(/\\s+$/,""),t.set_text(e))},()=>{t.execute()})}}}},{"./utils.js":4}],2:[function(e,t,n){const l=e("./utils.js");function s(e){var t=$('<div style="display:inline">',{class:"edit"}),n=e.element.find(".input_prompt");if(n)return n.css("display","inline-flex"),n.css("align-items","center"),n.css("height","30px"),e.element.find(".edit-btn").length||(t.html('<button class="edit-btn" type="button" style="height:19px;width:26px;margin-right:5px;font-size:25px;margin-top:1px;border-width:0px;background-color:white;overflow:visible" onclick="window.juno.openEditor(&#39;'+e.cell_id+'&#39;)">✎</button>'),n.prepend(t)),e}function o(e){e=e.element.find(".edit-btn");e.length&&e.remove()}function i(e){var t;e.element.find(".accept-cancel-container").length||((t=$("<div>",{class:"juno-button-container accept-cancel-container"})).html('<button type="button" class="juno-button accept-button" style="margin-left: 89px;" onclick="window.juno.edit_zones.accept(&#39;'+e.cell_id+'&#39;)">Accept</button><button type="button" class="cancel-button" style="margin-left: 5px;" onclick="window.juno.edit_zones.cancel(&#39;'+e.cell_id+'&#39;)">Cancel</button>'),t.find(".accept-button").prop("disabled",!0),e.element.append(t))}function r(e){null!=e&&(e=e.element.find(".accept-cancel-container")).length&&e.remove()}function a(e){var t=e.element.find(".accept-button");t.length||s(e),(t=e.element.find(".accept-button")).length&&t.prop("disabled",!1)}function c(e,t){var n;return e.element.find(".debug-container").length||((n=$("<div>",{class:"juno-button-container debug-container"})).html('<button type="button" class="juno-button debug-button" style="margin-left: 93px;" onclick="window.juno.openEditor(&#39;'+e.cell_id+'&#39;, true)">Debug</button>'),e.element.append(n)),e}function d(e){null!=e&&(e=e.element.find(".debug-container")).length&&e.remove()}class u{constructor(e,t){this.cell=e,this.editCells=[],this.accepted=!1,this.debugging=t,this._init()}_init(){o(this.cell),this.debugging&&d(this.cell),this.cell.element.addClass("edit-box-top"),this.cell.element.addClass("edit-box"),this.addEditCell(),this.showButtons()}addEditCell(){let e=0===this.editCells.length?Jupyter.notebook.find_cell_index(this.cell):Jupyter.notebook.find_cell_index(this.editCells[this.editCells.length-1]),t=Jupyter.notebook.insert_cell_below("code",e);t.element.addClass("edit-box-bottom"),t.element.addClass("edit-box"),this.editCells.push(t),this.debugging?(t.set_text("%debug "),setTimeout(()=>{var e=Jupyter.notebook.find_cell_index(t);Jupyter.notebook.execute_cells([e])},10)):(t.set_text("%edit "),setTimeout(()=>{Jupyter.notebook.select(e+1),t.focus_editor(),t.code_mirror.setCursor({line:0,ch:6})},200))}close(n){this.removeButtons();for(let e=0;e<this.editCells.length;e++){let t=this.editCells[e].cell_id;var o=Jupyter.notebook.get_cells().findIndex(e=>e.cell_id==t),i=o-1;n?(Jupyter.notebook.delete_cell(i),this.cell=Jupyter.notebook.get_cell(i)):Jupyter.notebook.delete_cell(o)}this.cell.element.removeClass("edit-box-bottom"),this.cell.element.removeClass("edit-box-top"),this.cell.element.removeClass("edit-box"),s(this.cell),!n&&this.debugging&&l.cellHasErrorOutput(this.cell)&&c(this.cell)}handleDeleteCell(t){if(!this.accepted)return this.cell.cell_id===t.cell_id?(this.cell=this.editCells[this.editCells.length-1],this.editCells.splice(this.editCells.length-1,1),this.close(),!0):!(!this.editCells.some(e=>e.cell_id===t.cell_id)||(this.editCells.splice(this.editCells.indexOf(t),1),0!==this.editCells.length)||(this.close(),0))}showButtons(){i(this.editCells[this.editCells.length-1])}enableButtons(){a(this.editCells[this.editCells.length-1])}removeButtons(){r(this.editCells[this.editCells.length-1])}containsCell(e){let t="string"==typeof e?e:e.cell_id;return this.cell.cell_id===t||this.editCells.some(e=>e.cell_id===t)}accept(e){this.accepted=!0,this.close(!0)}cancel(){this.close(!1)}}t.exports={EditZoneManager:class{constructor(){this.editZones={}}getZone(e){return this.editZones[e]}isEditCell(e){for(const t of Object.values(this.editZones))if(t.containsCell(e))return!0}createZone(e,t){this.editZones[e.cell_id]||(this.editZones[e.cell_id]=new u(e,t))}handleDeleteCell(e){for(var[t,n]of Object.entries(this.editZones))n.containsCell(e)&&n.handleDeleteCell(e)&&delete this.editZones[t]}accept(e){for(var[t,n]of Object.entries(this.editZones)){if(n.cell.cell_id===e)return n.accept(),void delete this.editZones[t];for(const o of n.editCells)if(o.cell_id===e)return n.accept(),void delete this.editZones[t]}}cancel(e){for(var[t,n]of Object.entries(this.editZones))n.containsCell(e)&&(n.cancel(),delete this.editZones[t])}handleDoneStreaming(e,t){if("edit"===e){var n=Jupyter.notebook.get_cells().find(e=>e.cell_id==t);if(n)for(var[o,i]of Object.entries(this.editZones))i.containsCell(n)&&(i.enableButtons(),n.execute())}}},addEditButtons:function(t){var n=Jupyter.notebook.get_cells();for(let e=0;e<n.length;e++){var o=n[e];"code"!==o.cell_type||t.isEditCell(o)||s(o,e)}},addEditButton:s,removeEditButton:o,addFixButton:c,removeFixButton:d,addStyles:()=>{var e,t;e=`
        .edit-btn {
            transition: color 0.3s ease;
            color: grey;
        }
        .edit-btn:hover {
            color: blue;
        }
        .edit-box-top {
            border-bottom: none!important;
            border-width: 2px!important;
            border-color: rgb(194, 194, 194)!important;
            margin-top: 4px!important;
            padding:11px!important;
        }
        .edit-box {
            background-color: rgb(245, 245, 245);
        }
        .edit-box-bottom {
            border-top: none!important;
            border-width: 2px!important;
            border-color: rgb(194, 194, 194)!important;
            margin-bottom: 4px!important;
            padding:11px!important;
        }
        div.cell.selected.edit-box:before, div.cell.selected.edit-box.jupyter-soft-selected:before {
            top: 3px;
            left: 3px;
            width: 5px;
            height: calc(100% -  6px);
        }
        
        .juno-button-container {
            display: flex;
            justify-content: space-between;
            width: fit-content;
            margin-top: 10px;
        }
        .juno-button-container.debug-container {
            margin-bottom: 10px;
        }

        .juno-button,
        .cancel-button {
            display: inline-block;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            padding: 7px 16px;
            border-radius: 2px;
            color: #ffffff;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        .juno-button {
            background-color: #0d257e;
            color: #ffffff;
        }

        .cancel-button {
            background-color: #f8f8f8;
            color: #070707;
        }

        .juno-button:hover,
        .cancel-button:hover {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
            transform: translateY(-1px);
        }

        .juno-button:active,
        .cancel-button:active {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transform: translateY(1px);
        }
        
        .juno-button:disabled,
        .cancel-button:disabled {
            background-color: #cccccc;
            color: #999999;
            cursor: not-allowed;
            box-shadow: none;
            opacity:0.75;
        }

        .juno-button:disabled:hover,
        .cancel-button:disabled:hover {
            transform: none;
        }
        
        .juno-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    `,(t=document.createElement("style")).textContent=e,document.head.append(t)}}},{"./utils.js":4}],3:[function(e,t,n){const o=e("./agent.js"),i=e("./utils.js"),{EditZoneManager:l,addEditButtons:s,addStyles:r,addFixButton:a,removeFixButton:c}=e("./handlers.js");class d{constructor(){this.initialized=!1,this.initialize()}initialize(){this.initialized||(this.juno_url="https://getjuno.ai/",this.api_endpoint="http://127.0.0.1:8000/",r(),this.agent_manager=new o,this.edit_zones=new l,this._listen(),this.initialized=!0)}cleanDebugButtons(e){var t,n;for([t,n]of Jupyter.notebook.get_cells().entries()){var o=i.cellHasErrorOutput(n)&&!this.edit_zones.isEditCell(n);o?a(n,t):e||o||c(n)}}_listen(){Jupyter.notebook.events.off("output_appended.OutputArea"),Jupyter.notebook.events.off("execute.CodeCell");let n=e=>{this.cleanDebugButtons(e),this.agent_manager.handle_output_appended()};Jupyter.notebook.events.on("output_appended.OutputArea",e=>{setTimeout(()=>n(!0),400),setTimeout(()=>n(!1),800),setTimeout(()=>n(!1),2e3)}),Jupyter.notebook.events.on("execute.CodeCell",(e,t)=>{setTimeout(()=>n(!1),400),setTimeout(()=>this.agent_manager.handle_cell_executed(t.cell),400),setTimeout(()=>{var e=t.cell.get_text();e.startsWith("juno_api_key =")&&(t.cell.clear_output(),t.cell.set_text(e+" ✅"),setTimeout(()=>{var e=Jupyter.notebook.find_cell_index(t.cell);Jupyter.notebook.delete_cell(e)},1e3))},400)}),Jupyter.notebook.events.on("create.Cell",()=>{setTimeout(()=>s(this.edit_zones),150),setTimeout(()=>s(this.edit_zones),400)}),setInterval(()=>s(this.edit_zones),3e3),setInterval(()=>this.cleanDebugButtons(!0),3e3),Jupyter.notebook.events.on("delete.Cell",(e,t)=>this.edit_zones.handleDeleteCell(t.cell)),s(this.edit_zones),setTimeout(()=>s(this.edit_zones),600)}openEditor(t,e=!1){var n=Jupyter.notebook.get_cells().find(e=>e.cell_id==t);this.edit_zones.createZone(n,e)}}(e=window).juno?e.juno.initialized||e.juno.initialize():e.juno=new d},{"./agent.js":1,"./handlers.js":2,"./utils.js":4}],4:[function(e,t,n){async function i(e,t){const{onMessage:n,...o}=t;for await(const l of async function*(e){var t=e.getReader();try{for(;;){var{done:n,value:o}=await t.read();if(n)return;yield o}}finally{t.releaseLock()}}((await fetch(e,o)).body)){var i=(new TextDecoder).decode(l);n(i)}void 0!==o.onDone&&o.onDone()}var s=["%juno","%action"];t.exports={generateId:function(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)},fetchSSE_agent:i,call:async function(t,e,n){e.visitor_id=localStorage.getItem("visitor_id"),e.api_key=localStorage.getItem("api_key"),t=await(await fetch(window.juno.api_endpoint+t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();try{n(t)}catch(e){console.log("Error parsing data",t,e)}},stream:async function(e,t,n,o){t.visitor_id=localStorage.getItem("visitor_id"),t.api_key=localStorage.getItem("api_key"),await i(window.juno.api_endpoint+e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),onMessage(e){e.split("data: ").forEach(t=>{if(0!==(t=t.trim()).length)if("[DONE]"===t)void 0!==o&&o();else if(0<t.length)try{var e=JSON.parse(t);n(e)}catch(e){console.log("Error parsing data",t,e)}})},onDone(){void 0!==o&&o()}})},getContext:function(t,n){var o=[],i=Jupyter.notebook.get_cells(),l=Jupyter.notebook.get_selected_index();for(let e=l-1-n;e>=Math.max(0,l-1-t);e--){let t=i[e].get_text();s.some(e=>t.trimStart().startsWith(e))||o.unshift(t)}return o.join("\\n###\\n")},replaceLastOccurrence:function(e,t,n){var o=e.lastIndexOf(t);return-1!==o?e.slice(0,o)+n+e.slice(o+t.length):e},cellHasErrorOutput:function(e){if(e.output_area&&e.output_area.outputs)for(const t of e.output_area.outputs)if("error"===t.output_type)return!0;return!1},cellHasOutput:function(e){return!(!e.output_area||!e.output_area.outputs)&&0<e.output_area.outputs.length}}},{}]},{},[3]);
